---
title: "Quero comprar um carro usado - parte 1"
date: "2017-01-06"
author: "António Cruz"
tags: ["Use case"]
categories: ["Exemplos"]
banner: "img/banners/chevrolet-1566063_1920.jpg"

---


Vamos supor que você pretende comprar um carro usado. O que faz?

Bem, presumo que das primeiras coisas é consultar algum site de compra e venda de carros usados e procurar algum carro com as características que considera relevantes de forma a ter uma ideia das alternativas e preços. Provavelmente até visitará algum stand recomendado por um amigo seu ou que fica perto da sua casa ou trabalho.

Mas, qual a melhor compra que pode fazer?

E se que quiser vender o meu carro? qual o preço que devo pedir?

Dependendo dos seus objetivos, se é comprar ou vender, se já escolheu a marca e modelo ou se apenas tem um limite de valor, se privilegia o preço, a idade os kms, todas estas questões vão influenciar como são recolhidos os dados, como é feita a análise exploratória e criados e testados os modelos ou simulações.

<font size="4" color="grey"> <b> Enquadramento e pressupostos </b></font>

Considerando que este exercício é meramente académico e pretende demonstrar algumas abordagens possíveis ao problema, vamos apresentar análises mais genéricas e variadas. 

Vou também dividir este trabalho em duas partes, para o documento não ser tornar demasiado extenso e cansativo para o leitor.

A primeira parte incluirá a recolha, tratamento e análise exploratória dos dados e na segunda parte iremos construir alguns modelos e retirar conhecimento dos dados que nos permitam tomar decisões informadas.

Para simplificar vou considerar alguns pressupostos:

* Quero um carro a gasóleo

* Pretendo um carro que tenha mais de 20 000kms e menos de 200 000 kms.

* Não quero gastar mais de 15 000€ e talvez só considere carros a partir de 4 000€ (quero um carro _jeitosito_)

* Não tenho preferência por marca ou modelo


Com estes pressupostos iniciais passamos a fase seguinte que é a da recolha dos dados que possam permitir encontrar respostas. 


<font size="4" color="grey"> <b> Recolha de dados </b></font>

Como em todos os processos de decisão, é necessário obter alguma informação prévia para podermos tomar uma decisão informada.

Em conformidade pesquisei informação sobre viaturas usadas em dois sites de referência em Portugal selecionei viaturas que cumpriam os meus pressupostos.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.width=7.2, fig.height=4.5, 
                      echo=FALSE, warning=FALSE, message=FALSE)
```



```{r}
library(tidyverse)
library(formattable)
library(ggthemes)
library(highcharter)
library(lazyrmd)
#library(printr)
library(DT)
library(viridis)
library(treemap)
#library(viridisLite)
library(broom)

print_highchart <- function(hc, name, width = 750, height = 450, ...) 
        {
        path_content <- "../htmlwidget/"
        file <- paste0(name, ".html")
        path_iframe <- "../../../../htmlwidget/"
        htmlwidgets::saveWidget(hc, file = paste0(path_content, file), 
                                selfcontained = TRUE, background = "transparent")

cat('<iframe src="', paste0(path_iframe, name), 
       '" width="', width, '" height="', height, '" frameborder="0" > </iframe>', sep = "")
}

print_datatable <- function(dt, name, width = 900, height = 600, ...) 
        {
        path_content <- "../datatable/"
        file <- paste0(name, ".html")
        path_iframe <- "../../../../datatable/"
        saveWidget(dt, file = paste0(path_content, file), 
                                selfcontained = TRUE, background = "transparent")

cat('<iframe src="', paste0(path_iframe, name), 
       '" width="', width, '" height="', height, '" frameborder="0" > </iframe>', sep = "")
}

viaturas <- read_rds("../../carros_usados.rds")

initial_rows <- nrow(viaturas)
```


Isso resultou na recolha de dados acerca de `r initial_rows`  viaturas.


A maioria da informação nos dois sites é idêntica ou muito semelhante pelo que conseguimos criar um conjunto de dados único e estandardizado.

No entanto os dados recolhidos necessitam de algum tratamento prévio antes de poder ser utilizado em modelos ou simulações. Os tratamentos mais comuns resultam de dados incompletos, errados, sem relevância para a análise.

<font size="4" color="grey"> <b> Limpeza e transformação dos dados </b></font>

É sempre necessário, também, proceder a alguma engenharia de variáveis (_feature engineering_). 
Por exemplo, a cilindrada consta apenas de descrição da viatura e como nós queremos usar essa informação posteriormente no modelo, é necessária extrai-la. O mesmo vamos ter de fazer para a marca e modelo.

Por outro lado, temos algumas marcas com poucas viaturas e, com poucos exemplos, as conclusões são sempre perigosas pelo que decidi ficar apenas com as marcas que tenham mais de 250 viaturas.

Temos outras questões de normalização que também acontecem sempre e que é necessário corrigir. Como recolhemos dados de duas origens distintas, existem dados que representam o mesmo objeto, mas são descritos com nomes diferentes. Num dos sites as viaturas tem como marca _volkswagen_ e no segundo site são classificadas como _vw_. Esta situação também será corrigida.



```{r}
viaturas <- viaturas %>% filter(!is.na(cilindrada),
                                !is.na(potencia),
                                potencia > 15,
                                cilindrada != 0,
                                cilindrada < 8,
                                potencia < 300) %>% 
        mutate(
                marca = ifelse(marca == "vw", "volkswagen", marca),
                site = factor(site),
                cilindrada = as.numeric(cilindrada)
        )

marcas <- viaturas %>% count(marca) %>% arrange(-n) %>% filter(n>235) %>% .$marca 


viaturas <- viaturas %>% 
        filter(marca %in% marcas) %>% 
        mutate(
                marca = factor(marca),
                modelo = factor(modelo)
        )

step1_rows <- nrow(viaturas)

```

Depois de efetuadas as correções iniciais, ficamos com a informação de `r step1_rows` viaturas, uma redução de `r percent((initial_rows-step1_rows)/initial_rows, 1)`, sendo que `r nrow(viaturas %>% filter(site == "site1"))` viaturas foram recolhidas do __site1__ e `r nrow(viaturas %>% filter(site == "site2"))` do __site2__.

Mas ainda não terminamos. Existem questões adicionais que devem ser abordadas, nomeadamente:

* modelos de marca com poucas viaturas

* anos de matricula muito antigos

Relativamente à primeira questão, para já não vamos fazer nada. 
No que diz respeito ao ano de matricula, existem de facto um número reduzido de viaturas com matricula anterior a 2000, que sendo muito antigas, pese embora estarem dentro do intervalo de kms inicialmente definido, não nos interessam. 
Assim iremos eliminar as viaturas anteriores com matricula anterior ao ano 2000.


```{r}
viaturas <- viaturas %>% filter(ano >= 2000)
step2_rows <- nrow(viaturas)
```

Depois de um novo _round_ de alterações, ficamos com a informação de `r step2_rows` viaturas, uma redução de `r percent((initial_rows-step2_rows)/initial_rows, 1)` relativamente ao número inicial.

Uma outra alteração que vamos fazer e que nos poderá ser util, nesta fase não sabemos, é criar novas variáveis com base na informação existente:

* a idade da viatura. É um processo muito simples já que a única coisa que fazemos é subtrair a 2017 o ano de matricula. Assim, uma viatura de 2016 têm um ano e outra de 2010 têm 7 anos.

* kms por ano. Variável igualmente simples já que nos limitamos a dividir o número de kms pela idade

É claro que estamos a simplificar e tratar uma viatura de dezembro da mesma forma que tratamos outra do mesmo ano, mas de janeiro. É uma questão de simplificação, mas poderíamos facilmente tratarmos em meses em vez de anos, caso tivéssemos nos nossos dados o mês de matricula (por acaso temos para um dos sites mas não para o outro).

A titulo de exemplificação, porque em problemas reais isto acontece com frequência, poderíamos prever o mês de matricula das viaturas em falta (se não fossem muitas) com base nos kms, marca e modelo (por exemplo). Assim poderíamos ter mais uma variável no modelo.

```{r results='asis'}
viaturas <- viaturas %>% mutate(idade = 2017-ano, kms_ano = round(kms / idade, 0)) %>% 
        select(veiculo, marca, modelo, preco, kms, idade, potencia, cilindrada, kms_ano, site)


```



Nesta fase já temos um conjunto de dados suficientemente preparados para podermos fazer uma análise exploratória.


<font size="4" color="grey"> <b> Análise exploratória </b></font>

De que dados dispomos, neste momento?

Temos um conjunto de `r nrow(viaturas)` viaturas que são caracterizadas por `r ncol(viaturas)` variáveis.

A estrutura dos nossos dados é a seguinte:

```{r }
summary(viaturas)

```

Podemos igualmente dar uma espreitadela a 20 registos selecionados de forma aleatória.

```{r results='asis'}
print_datatable(datatable(as.data.frame(sample_n(viaturas, 20)), 
                          caption = 'Exemplos de viaturas tratadas.',
                          colnames = c('Viatura', 'Marca', 'Modelo', 'Preço', 
                                       'kms', 'idade', 'Potência - CV',
                                       'Cilindrada', 'kms por ano',
                                       'Site de origem'),
                           class = 'cell-border stripe'), "dt1")
```


<br>
<font size="2" color="grey"> <b> Por marca  </b></font>
<br>

Podemos verificar que a maioria das viaturas que fazem parte da nossa amostra são da marca __Renault__ e representam `r percent(nrow(viaturas[viaturas$marca == "renault",]) / nrow(viaturas), 1)`. 

```{r results='asis'}
hc1 <- viaturas %>% count(marca) %>% arrange(-n) %>%  
        hchart(., x = marca, y = n, type = "bar", color = n) %>%
        hc_title(text = "Renault é a marca mais representada na nossa amostra",
                 align = "left") %>% 
        hc_subtitle(text = "Apenas estão consideradas as marcas com mais de 235 viaturas", align = "left") %>% 
        hc_credits(enabled = TRUE, # add credits
                   text = "fonte: 2 sites publicos de carro usados") %>% 
        hc_yAxis(title = list(text = NULL),
                 align = "left",
                 showFirstLabel = FALSE,
                 showLastLabel = FALSE) %>% 
        hc_xAxis(title = list(text = "Idade em anos")) %>% 
        hc_plotOptions(bar = list(dataLabels = list(enabled = TRUE,
                                                       format = '{point.y:.0f}'))) %>% 
        hc_tooltip(crosshairs = TRUE, backgroundColor = "#FCFFC5",
                   shared = FALSE, borderWidth = 1) %>% 
        hc_exporting(enabled = TRUE) %>% 
        hc_add_theme(hc_theme_google()) 

print_highchart(hc1, "hc1")
```

<br>

Não é de mais destacar que nós temos misturadas viaturas sedan, compactas, de serviço e carrinhas de diferentes modelos na amostra e que esse facto tem obviamente impacto nas análises e conclusões que tiramos. 

Apesar de termos retirado da amostra as marcas com poucas viaturas, temos modelos dentro das marcas que possuem muito poucas viaturas. Para percebermos melhor esse fenómeno, apresentamos a _treemap_ seguinte onde poderão com o cursor em cima do conjunto de modelos de uma marca, clicar e ver apenas os modelos dessa marca.

```{r include=FALSE}

tm <- treemap(viaturas %>% count(marca, modelo), index = c("marca", "modelo"),
                        vSize = "n", vColor = "n",
                        type = "value", palette = viridis(10), draw = FALSE)
```

```{r results='asis' }

hc_tm <- highchart() %>% 
        hc_add_series_treemap(tm, 
                allowDrillToNode = TRUE,
                layoutAlgorithm = "squarified") %>% 
        hc_title(text = "Viaturas por marca e modelo") %>% 
        hc_tooltip(pointFormat = "<b>{point.name}</b>:<br>Nº Viaturas: {point.value:,.0f}")

print_highchart(hc_tm, "hc_tm")
```

A _peugeot_ é a marca com mais modelo (20), seguida da _fiat_ (18) e da _citroen_ (15).


<br>
<font size="2" color="grey"> <b> Por preço  </b></font>
<br>

Relativamente aos preços, encontrei algumas surpresas nos dados. Eu não percebo muito do mercado de carros usados, mas considerando que estamos perante carros a gasóleo com até 17 anos de idade e com até 200 000km, e considerando as análises já efetuadas em que a maioria das marcas e modelos presentes na nossa amostra são da gama média, num mercado como o português, devo ser sincero, estava à espera de valores mais baixos.

Vamos ver então a distribuição das nossas viaturas por preço:

```{r results='asis'}

hc2 <- hchart(viaturas$preco, name = "Preço das viaturas", breaks = 40) %>% 
        hc_title(text = "Preço das viaturas concentrado entre os 10 e 14.9 mil Euros",
                 align = "left") %>% 
        hc_subtitle(text = "Distribuição é fortemente inclinada para a direita ", align = "left") %>% 
        hc_credits(enabled = TRUE, # add credits
                   text = "fonte: 2 sites publicos de carro usados") %>% 
        hc_yAxis(title = list(text = "Nº de viaturas"),
                 align = "left",
                 showFirstLabel = FALSE,
                 showLastLabel = FALSE) %>% 
        hc_xAxis(title = list(text = NULL)) %>% 
        hc_exporting(enabled = TRUE) %>% 
        hc_add_theme(hc_theme_flat()) 


print_highchart(hc2, "hc2")
```

Podem utilizar o rato para fazer zoom. Os _bins_ são de 200€ cada. Este histograma é muito interessante porque mostra claramente a _jogada_ do preço psicológico. Existe, para todos os intervalos de 1000€, um padrão: muito poucas viaturas a seguir a cada milhar e depois a grande maioria das viaturas está concentrada próxima do milhar seguinte.

Mas esta distribuição não será igual para todas as marcas. E queremos também perceber isso e de que forma os preços variam por marca. É o que tentaremos verificar no gráfico seguinte:


```{r }
viaturas %>% mutate(bin = cut(preco, breaks = seq(4000, 15000,500))) %>% 
        count(marca, bin) %>% 
        mutate(mean_n = mean(n), 
               n3 = n / mean_n,
               n1 = n-mean_n, n2 = round(n1 / mean_n, 2)) %>% 
        ggplot(aes(x = bin, y = n3, fill = n3)) +
        labs(title = "Audi é a marca que têm mais carros com os preços mais elevados", 
             subtitle = "Fiat e Opel têm uma distribuição dos preços mais equilibrada", 
             caption = "fonte: 2 sites públicos de carros usados",
             y = "", x = "Preço das viaturas") +
        geom_bar(stat = "identity") + #coord_flip() +
        scale_x_discrete(labels = NULL) +
        guides(fill=FALSE) +
        facet_wrap(~marca) +
        theme_hc() +
        scale_fill_distiller(palette = "Spectral")

```


Uma explicação prévia. Como existem marcas com muito mais viaturas que outras, nomeadamente a _Renault_, se me limitasse a criar o gráfico na escala normal, o grande número de viaturas _Renault_ iria impedir que conseguíssemos perceber a distribuição dos preços para a maioria das marcas. Assim, fiz uma _normalização_ prévia à escala de contagem: como podem verifica a escala varia de 0 a 4 e representa, em cada marca, o numero de viaturas de cada escalão de preços a dividir pela média de viaturas por escalão de cada marca. 

Por exemplo, no caso da _Audi_, o ultimo escalão de preços, de 14500€ a 15000€ têm 4 vezes mais viaturas que a média dos escalões da Audi. Se for inferior a um, significa que está abaixo da média.

Desta forma a escola apresentada é idêntica para todas as marcas. 

Podemos claramente verificar que na Audi as viaturas estão concentradas nos últimos escalões, o que seria de esperar.

A _Fiat_, _Ford_, _Opel_ e Toyota_ apresentam uma distribuição por preços relativamente uniforme.

A _Volkswagen_ e a _Volvo_ também apresentam uma concentração das viaturas nos escalões de preços mais elevados. 

De forma surpreendente, pelo menos para mim, a _Renault_ apresenta alguma concentração nos preços mais elevados. É surpreendente porque sendo uma marca generalista com os principais modelos no segmento médio e sendo a marca com maior número de viaturas à venda, esperaria um menor preço.


```{r results='asis'}

hc3 <- highchart() %>% 
        hc_add_series_boxplot(viaturas$preco, viaturas$marca,
                              name = "Preço") %>% 
        hc_title(text = "Preços de venda por marca") %>% 
        hc_subtitle(text = "Audi têm os preços mais elevados e a Fiat os mais baixos") %>% 
        hc_credits(enabled = TRUE, text = "fonte: 2 sites públicos de carros usados") %>% 
        hc_yAxis(title = list(text = "Preços"),
                 align = "left",
                 showFirstLabel = FALSE,
                 showLastLabel = FALSE) %>% 
        hc_xAxis(title = list(text = NULL)) %>% 
        hc_tooltip(backgroundColor = "#FCFFC5", shared = FALSE, borderWidth = 1) %>% 
        hc_exporting(enabled = TRUE) %>% 
        hc_add_theme(hc_theme_flat()) 


print_highchart(hc3, "hc3")
```

O _boxplot_ acima confirma a análise feita relativamente aos preços no histograma anterior, embora com informação diferente.

A marca com preços mais altos é a _Audi_ e a _Fiat_ é a que têm os preços mais baratos.

A diferença de preços em termos de mediana, se retirarmos a _Audi_ e a _Fiat_ não é muito grande. A _Toyota_ e a _Seat_ têm a menor dispersão de preços quando avaliada pela diferença entre o 1º e 3º quartil.

A _Audi_, _Seat_, _Volkswagen_ e _Volvo_ apresentam _outliers_, viaturas com preços demasiado baixos.



<br>
<font size="2" color="grey"> <b> Por kms  </b></font>
<br>

Sabemos que a idade das viaturas presentes varia entre 1 e 17 anos. Mas será que as viaturas estão distribuídas de forma uniforme por idade? ou existem idades mais comuns? E o comportamento geral é igual para todas as marcas? 

Vamos tentar perceber.

```{r results='asis'}

hc4 <- hchart(viaturas$kms, name = "kms", breaks = 40) %>% 
        hc_title(text = "Kms das viaturas concentrado entre os 115000 e os 160000 kms",
                 align = "left") %>% 
        hc_subtitle(text = "Distribuição é moderadamente inclinada para a esquerda ", 
                    align = "left") %>% 
        hc_credits(enabled = TRUE, # add credits
                   text = "fonte: 2 sites públicos de carro usados") %>% 
        hc_yAxis(title = list(text = "Nº de viaturas"),
                 align = "left",
                 showFirstLabel = FALSE,
                 showLastLabel = FALSE) %>% 
        hc_xAxis(title = list(text = NULL)) %>% 
        hc_exporting(enabled = TRUE) %>% 
        hc_add_theme(hc_theme_economist()) 


print_highchart(hc4, "hc4")
```

Mais uma vez temos um comportamento _kms psicológicos_ tal como nos preços. Embora esse comportamento só é mais notório a partir dos 120000kms, é muito claro que o número de viaturas aumenta significativamente antes de ultrapassar a dezena de milhar de kms. Se isto era algo plausível nos preços, nos kms é mais difícil de aceitar como correspondendo à realidade. 
O mais provável que esteja a acontecer é os potencias vendedores indicarem no site um número de kms que é inferior à quilometragem real.

De qualquer forma, a maioria das viaturas da nossa amostra tem um número de kms razoável, ente os 115000kms e os 180000kms.

E qual é a distribuição por marca? Querem tentar adivinhar qual a marca que, em média, faz mais kms?

```{r }
viaturas %>% mutate(bin = cut(kms, breaks = seq(5000, 200000,5000))) %>% 
        count(marca, bin) %>% 
        mutate(mean_n = mean(n), 
               n3 = n / mean_n,
               n1 = n-mean_n, n2 = round(n1 / mean_n, 2)) %>% 
        ggplot(aes(x = bin, y = n3, fill = n3)) +
        labs(title = "Audi é a marca que têm mais viaturas com mais kms", 
             subtitle = "Fiat e Opel têm uma distribuição dos preços mais equilibrada", 
             caption = "fonte: 2 sites públicos de carros usados",
             y = "", x = "Preço das viaturas") +
        geom_bar(stat = "identity") + #coord_flip() +
        scale_x_discrete(labels = NULL) +
        guides(fill=FALSE) +
        facet_wrap(~marca) +
        theme_economist() +
        scale_fill_distiller(palette = "Spectral")

```

É a _Audi_ que se destaca na distribuição dos kms tendo uma boa parte das suas viaturas mais de 170000kms.

A _Ford_ também se destaca com uma distribuição dos kms efetuados bastante homogéneos.

```{r results='asis'}

hc5 <- highchart() %>% 
        hc_add_series_boxplot(viaturas$kms, viaturas$marca,
                              name = "Kms") %>% 
        hc_title(text = "kms por marca") %>% 
        hc_subtitle(text = "A Audi têm as viaturas com mais kms e a Fiat com menos") %>% 
        hc_credits(enabled = TRUE, text = "fonte: 2 sites públicos de carros usados") %>% 
        hc_yAxis(title = list(text = "kms"),
                 align = "left",
                 showFirstLabel = FALSE,
                 showLastLabel = FALSE) %>% 
        hc_xAxis(title = list(text = NULL)) %>% 
        hc_tooltip(backgroundColor = "#FCFFC5", shared = FALSE, borderWidth = 1) %>% 
        hc_exporting(enabled = TRUE) %>% 
        hc_add_theme(hc_theme_economist()) 

print_highchart(hc5, "hc5")
```

A _Audi_, al como verificado na analise anterior, tem a viaturas com mais kms, com uma mediana de 163000 kms.

Por sua vez é à _Fiat_ que cabe o prémio da marca com menos kms, com uma mediana de 96000 kms.

A _Audi_ e a _Renault_ apresentam a menor distancia entre o 1º e 3º quartil o que representa uma menor variabilidade nos kms percorridos, sendo precisamente estas duas marcas que apresentam viaturas com kms fora do comum (_outliers_ no caso concreto com poucos kms).

<br>
<font size="2" color="grey"> <b> Por idade  </b></font>
<br>

As viaturas à vendas nos dois sites analisados não são muito antigas. Aparentemente a altura mais comum para venda está entre os 4 e os 7 anos.

Vamos encontrar, tal como para os preços e kms, uma distribuição por idades diferenciada por marca?

```{r results='asis'}

hc6 <- viaturas %>% count(idade) %>% 
        hchart(type = "column", x = idade, y = n, color = n) %>% 
        hc_title(text = "Idade das viaturas concentrada entre os 4 e 7 anos",
                 align = "left") %>% 
        hc_subtitle(text = "Distribuição é fortemente inclinada para a direita ", 
                    align = "left") %>% 
        hc_credits(enabled = TRUE, # add credits
                   text = "fonte: 2 sites públicos de carro usados") %>% 
        hc_yAxis(title = list(text = "Nº de viaturas"),
                 align = "left",
                 showFirstLabel = FALSE,
                 showLastLabel = FALSE) %>% 
        hc_xAxis(title = list(text = NULL)) %>% 
        hc_exporting(enabled = TRUE) %>% 
        hc_add_theme(hc_theme_ft()) 


print_highchart(hc6, "hc6")
```

Tal como para os preços e kms, quando analisamos por marca utilizamos a escala _normalizada_, já explicada na parte referente aos preços.

E efetivamente, a distribuição por idades varia por marca.


```{r }
viaturas %>% 
        count(marca, idade) %>% 
        mutate(mean_n = mean(n), 
               n3 = n / mean_n,
               n1 = n-mean_n, n2 = round(n1 / mean_n, 2)) %>% 
        ggplot(aes(x = idade, y = n3, fill = n3)) +
        labs(title = "Idade das viaturas por marca", 
             subtitle = "Renault com a maioria das viaturas com 4 e 5 anos", 
             caption = "fonte: 2 sites públicos de carros usados",
             y = "", x = "Idade das viaturas") +
        geom_bar(stat = "identity") + #coord_flip() +
        #scale_x_discrete(labels = NULL) +
        guides(fill=FALSE) +
        facet_wrap(~marca) +
        theme_solarized() +
        scale_fill_distiller(palette = "Spectral")

```

Podemos verificar que a _Renault_ tem a maioria das viaturas com 4 e 5 anos e a _Volkswagen_ com 5 e 6 anos.


```{r results='asis'}

hc7 <- highchart() %>% 
        hc_add_series_boxplot(viaturas$idade, viaturas$marca,
                              name = "Preço") %>% 
        hc_title(text = "Idade por marca") %>% 
        hc_subtitle(text = "Audi têm os carros mais antigos") %>% 
        hc_credits(enabled = TRUE, text = "fonte: 2 sites públicos de carros usados") %>% 
        hc_yAxis(title = list(text = "Preços"),
                 align = "left",
                 showFirstLabel = FALSE,
                 showLastLabel = FALSE) %>% 
        hc_xAxis(title = list(text = NULL)) %>% 
        hc_tooltip(backgroundColor = "#FCFFC5", shared = FALSE, borderWidth = 1) %>% 
        hc_exporting(enabled = TRUE) %>% 
        hc_add_theme(hc_theme_ft()) 


print_highchart(hc7, "hc7")
```

É curioso que a _Audi_ tem claramente os carros mais antigos da nossa amostra, seguida da _Toyota_. Nas restantes marcas não existem grandes diferenças, pese embora a _Renault_, _Seat_ e _Volkswagen_ registarem _outliers_.

Apesar de registarem _Outliers_, a _Citroen_, _Seat_ e _Toyota_ tem a menor variabilidade na idade.

<br>
<font size="2" color="grey"> <b> Relação entre o Preço e kms </b></font>
<br>

Uma das questões fundamentais que se irá colocar na criação dos modelos é perceber quais as variáveis independentes que explicam a variação na nossa variável dependente que é o preço.

Nesta fase e pretendendo perceber essa relação iremos comparar algumas das variáveis começando pelos kms.


```{r}
viaturas %>% group_by(marca) %>% 
        do(fitmodel = lm(preco ~ kms, data = .)) %>% tidy(fitmodel) %>% 
        filter(term == "kms") %>% select(estimate) %>%
        mutate(estimate = round(estimate*1000, 0), 
               label=paste("Inclinação:", estimate)) %>% 
        right_join(viaturas) %>% 
        ggplot(aes(x = kms, y = preco)) +
        geom_point(aes(color = modelo)) +
        theme_solarized() +
        labs(title = "Relação entre o preço e os kms realizados (Euro por cada 1000kms)", 
             subtitle = "Volkswagen é a marca que perde menos valor com os kms percorridos", 
             caption = "fonte: 2 sites públicos de carros usados",
             x = "kms das viaturas",
             y = "Preço") +
        facet_wrap(~marca) + 
        guides(color=FALSE) +
        geom_smooth(method = "lm", se = FALSE) +
        geom_text(aes(100000, 16500, label=label), size = 2.5, color = "grey50") 

```

<br>

Cada ponto representa uma viatura e as cores representam os modelos. A inclinação representa o valor que a marca perde com os kms realizados (o número indicado representa a variação no valor por cada 1000kms percorridos).
<br>
Conseguimos perceber rapidamente as marcas com mais ou menos observações na nossa amostra, as que tem mais ou menos modelos e a inclinação da reta.

A marca que perde menos valor com os kms percorridos é a _Volkswagen_ (18€), valor que é menos de metade quando comparada com a marca que perde mais que é a _Fiat_ (40€).


<br>
<font size="2" color="grey"> <b> Relação entre o Preço e idade </b></font>
<br>

E relativamente à idade? qual o valor que cada marca perde a cada ano que passa?


```{r}
viaturas %>% group_by(marca) %>% 
        do(fitmodel = lm(preco ~ idade, data = .)) %>% tidy(fitmodel) %>% 
        filter(term == "idade") %>% select(estimate) %>%
        mutate(estimate = round(estimate, 0), 
               label=paste("Inclinação:", estimate)) %>% 
        right_join(viaturas) %>% 
        ggplot(aes(x = idade, y = preco)) +
        geom_point(aes(color = modelo), alpha = 0.4) +
        theme_solarized() +
        labs(title = "Relação entre o preço e a idade (Euro por cada ano)", 
             subtitle = "Volkswagen é a marca que perde menos valor com a idade", 
             caption = "fonte: 2 sites públicos de carros usados",
             x = "Idade das viaturas",
             y = "Preço") +
        facet_wrap(~marca) + 
        guides(color=FALSE) +
        geom_smooth(method = "lm", se = FALSE) +
        geom_text(aes(7, 16500, label=label), size = 2.5, color = "grey50") 

```
<br>

Como podem reparar, algumas marcas, com destaque para a _Audi_ e _Volvo_, não tem na nossa amostra viaturas muito novas, enquanto outras tem viaturas muto novas como é o caso da _Opel_. Tal facto deve-se, penso eu, por termos limitado o valor a 15000€ e com poucos anos o valor das viaturas usadas quer da _Audi_ como da _Volvo_ ultrapassam o limite que fixamos.

No entanto é interessante verificar que com base nos nossos dados, as viaturas que menos valor perdem com o passar dos anos são a _Volkswagen_, _Toyota_ e a _Seat_ (uma surpresa).

No lado oposto as marcas que perdem mais valor com o passar do tempo é a _Peugeot_ e a _Renault_.

<br>
<font size="2" color="grey"> <b> Correlações </b></font>
<br>

Podemos tentar perceber outras correlações, nomeadamente entre as variáveis quantitativas:

```{r results='asis'}

hc10 <- viaturas %>% select(preco, kms, idade, potencia, cilindrada, kms_ano) %>% cor %>% 
        hchart() %>% 
        hc_title(text = "Correlação entre as variáveis quantitativas",
                 align = "left") %>% 
        hc_subtitle(text = "Preço está mais fortemente correlacionado negativamente com a idade e positivamente com os kms por ano", 
                    align = "left") %>% 
        hc_credits(enabled = TRUE, # add credits
                   text = "fonte: 2 sites publicos de carro usados") %>% 
        hc_exporting(enabled = TRUE) 

print_highchart(hc10, "hc10")
```

Confirmando as analises anteriores, temos que o preço se correlaciona negativamente com os kms realizados e a idade, embora essa correlação seja mais forte com a idade (-0.72 versus -0.41), i.e., é mais importante a idade que os kms no preço de venda.

Mas temos uma descoberta que é contrária ao censo comum: o preço correlaciona-se positivamente com a média dos kms anuais, i.e., as viaturas que fazem mais kms por ano tem preços mais elevados.

Se repararmos, a média dos kms por ano correlaciona-se negativamente com a idade e essa pode ser a razão que explica esta estranha descoberta: os carros mais novos são mais utilizados e fazem em média mais kms e quando vão ficando mais velhos a sua utilização vai diminuindo. Parece ser uma explicação razoável e que faz sentido.

<br>

Podemos também relacionar as marcas calculando a distância entre elas. Neste caso foi calculada a distância euclidiana entre as marcas considerando as variáveis preço, kms realizados, idade, potencia e cilindrada.

```{r results='asis'}
marc_dist <- viaturas %>% 
        select(-veiculo, -modelo, -site, -kms_ano) %>% 
        group_by(marca) %>% 
        summarise_each(funs(mean)) %>% as.data.frame %>% 
        column_to_rownames("marca") %>% 
        scale()


order_nb <- marc_dist %>%  dist %>% as.matrix() %>% .[,"audi"] %>% data.frame %>% 
        rownames_to_column(var = "marca")
names(order_nb) <- c("marca", "v")
order_nb <- order_nb %>% arrange(-v) %>% .$marca



hc11 <- marc_dist[order_nb,] %>% dist %>% hchart() %>% 
        hc_title(text = "Distância entre as marcas",
                 align = "left") %>% 
        hc_subtitle(text = "Consideradas as variáveis preço, kms, idade, potencia e cilindrada", 
                    align = "left") %>% 
        hc_credits(enabled = TRUE, # add credits
                   text = "fonte: 2 sites publicos de carro usados") %>% 
        hc_exporting(enabled = TRUE) 

print_highchart(hc11, "hc11")
```

<br>
A Matriz está ordenada por distância e os estremos são a _Fiat_ e a _Audi_. A distância vai de zero (quando comparamos uma marca com ela própria, representada pela diagonal do quadrado) até 8.33 que é a distância que separa a _Fiat_ da _Audi_.
<br>
Interessante verificar que depois de contabilizados os kms, idade e preço de usado a _Citroen_ e a _Peugeot_ continuam muito próximas.

Apesar da _Volvo_ e _Volkswagen_ serem as marcas mais próximas da _Audi_, a distância que as separa é significativa.

Podem verificar as distâncias entre marcas colocando o cursor em cima da célula ente linhas e colunas.


<br>
<font size="2" color="grey"> <b> Questões finais </b></font>
<br>


Não diria que foi uma análise exaustiva, mas foi longa e espero que a tenham lido até ao fim.

Julgo que conseguimos perceber coisas interessantes a compreender melhor a estrutura e distribuição dos dados, conhecimento que será bastante útil para a 2ª parte deste trabalho, parte essa onde iremos construir alguns modelos e realizar algumas simulações que nos ajudem a responder a questões concretas que irei colocar.

Vemo-nos na parte 2 deste exemplo.


