---
title: "Um bom negócio?"
date: "2017-01-16"
author: "António Cruz"
tags: ["Use case"]
categories: ["Exemplos"]
banner: "img/banners/viatura3.jpg"
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.width=7.2, fig.height=4.5, 
                      echo=FALSE, warning=FALSE, message=FALSE)
```



```{r}
library(tidyverse)
library(formattable)
library(ggthemes)
library(highcharter)
library(lazyrmd)
#library(printr)
library(DT)
library(viridis)
library(treemap)
library(htmltools)
library(purrr)
#library(viridisLite)
library(broom)
library(stringr)
library(ggrepel)
library(ggsci)

print_highchart <- function(hc, name, width = 850, height = 550, ...) 
        {
        path_content <- "../htmlwidget/"
        file <- paste0(name, ".html")
        path_iframe <- "../../../../htmlwidget/"
        htmlwidgets::saveWidget(hc, file = paste0(path_content, file), 
                                selfcontained = TRUE, background = "transparent")

cat('<iframe src="', paste0(path_iframe, name), 
       '" width="', width, '" height="', height, '" frameborder="0"> </iframe>', sep = "")
}

print_datatable <- function(dt, name, width = 900, height = 600, ...) 
        {
        path_content <- "../datatable/"
        file <- paste0(name, ".html")
        path_iframe <- "../../../../datatable/"
        saveWidget(dt, file = paste0(path_content, file), 
                                selfcontained = TRUE, background = "transparent")

cat('<iframe src="', paste0(path_iframe, name), 
       '" width="', width, '" height="', height, '" frameborder="0" > </iframe>', sep = "")
}

viaturas <- read_rds("../../carros_usados.rds")

initial_rows <- nrow(viaturas)

fonte <- "fonte: 2 sites públicos de carros usados"
```


```{r}
viaturas <- viaturas %>% filter(!is.na(cilindrada),
                                !is.na(potencia),
                                potencia > 15,
                                cilindrada != 0,
                                cilindrada < 8,
                                potencia < 300) %>% 
        mutate(
                marca = ifelse(marca == "vw", "volkswagen", marca),
                site = factor(site),
                cilindrada = as.numeric(cilindrada)
        )

marcas <- viaturas %>% count(marca) %>% arrange(-n) %>% filter(n>235) %>% .$marca 


viaturas <- viaturas %>% 
        filter(marca %in% marcas) %>% 
        mutate(
                marca = factor(marca),
                modelo = factor(modelo)
        )

step1_rows <- nrow(viaturas)

viaturas <- viaturas %>% filter(ano >= 2000)
step2_rows <- nrow(viaturas)

viaturas <- viaturas %>% mutate(idade = 2017-ano, kms_ano = round(kms / idade, 0)) %>% 
        select(veiculo, marca, modelo, preco, kms, idade, potencia, cilindrada, kms_ano, site)

```


Vamos supor que você pretende comprar um carro usado. O que faz?

Bem, presumo que das primeiras coisas é consultar algum site de compra e venda de carros usados e procurar algum carro com as características que considera relevantes de forma a ter uma ideia das alternativas e preços. Provavelmente até visitará algum stand recomendado por um amigo seu ou que fica perto da sua casa ou trabalho.

Mas, qual a melhor compra que pode fazer?

E se que quiser vender o carro? qual o preço que deve pedir?

Dependendo dos seus objetivos, se é comprar ou vender, se já escolheu a marca e modelo ou se apenas tem um limite de valor, se privilegia o preço, a idade ou os kms, todas estas questões vão influenciar a sua decisão final e eventualmente gerar alternativas demasiado numerosas que permitam um enfoque nas propostas mais interessantes.
<br>

A compra ou venda de um carro é apenas o pretexto para exemplificar algumas técnicas da ciência de dados que poderão ser aplicadas perante situações de incerteza, nomeadamente a simulação e a regressão linear.
<br>

A mesma lógica poderia ser aplicada se estivéssemos a falar de casas, de escolhas a serem feitas por departamento de compras de uma organização, a decidir quantos funcionários devem estar na loja a um determinado dia ou hora, qual a quantidade a armazenar de determinado produto ou a tentar perceber qual o melhor preço a praticar.
<br>

Embora este seja um exercício académico no sentido em que coloco questões que certamente seriam diferentes das colocadas por alguém que efetivamente quisesse comprar ou vender um carro, os dados são reais e as questões colocadas parecem-me suficientemente práticas para acrescentarem valor. 


<font size="4" color="grey"> <b> Recolha de dados </b></font>

Como em todos os processos de decisão, é necessário obter alguma informação prévia para podermos tomar uma decisão informada.

Em conformidade recolhi informação sobre viaturas usadas em dois sites de referência em Portugal e extrai os dados relativos às viaturas que cumpriam os seguintes pressupostos (os meus requisitos mínimos):

* Carros a gasóleo;

* Carros com mais de 20 000 kms e menos de 200 000 kms;

* Preços entre 4 000€ e 15 000€;

* Sem preferências por marca ou modelo.


Das viaturas recolhidas selecionei as marcas que tivessem pelo menos 235 viaturas e foi efetuado algum trabalho de transformação de forma a ter dados estandardizados e devidamente preparados para análise. Entre estas transformações estão a eliminação de viaturas muito antigas, marcas com poucas viaturas, normalização de nomes, etc.

Da análise prévia ficamos a saber algumas coisas da estrutura dos nossos dados, nomeadamente:

* Temos um conjunto de `r nrow(viaturas)` viaturas que são caracterizadas por `r ncol(viaturas)` variáveis: Descrição, marca, modelo, preço em Euros, Kms realizados, idade em anos, a potência em cavalos, a cilindrada, a média dos kms realizados por ano e qual o site de onde foi extraída a viatura;

* A _Renault_ é a marca que tem mais viaturas, `r viaturas %>% filter(marca == "renault") %>% summarise(n = n()) %>% .$n`;

* Foram extraidas `r nrow(viaturas %>% filter(site == "site1"))` viaturas  do __site1__ e `r nrow(viaturas %>% filter(site == "site2"))` do __site2__;

* A _Peugeot_ é a marca com mais modelos, `r viaturas %>% filter(marca == "peugeot") %>% summarise(n = n_distinct(modelo)) %>% .$n`;

* A marca mais cara é a _Audi_ com uma média de preços de `r viaturas %>% filter(marca =="audi") %>% summarise(media = mean(preco)) %>% .$media %>% currency(.,"€", digits = 0)` e uma mediana de `r viaturas %>% filter(marca =="audi") %>% summarise(mediana = median(preco)) %>% .$mediana %>% currency(.,"€", digits = 0)`;

* A marca mais barata é a _Fiat_ com uma média de preços de `r viaturas %>% filter(marca =="fiat") %>% summarise(media = mean(preco)) %>% .$media%>% currency(.,"€", digits = 0)` e uma mediana de `r viaturas %>% filter(marca =="fiat") %>% summarise(mediana = median(preco)) %>% .$mediana %>% currency(.,"€", digits = 0)`;


<br>


O gráfico seguinte ajuda-nos a perceber melhor as possíveis correlações entre as variáveis quantitativas:

```{r results='asis'}

hc2 <- viaturas %>% select(preco, kms, idade, potencia, cilindrada, kms_ano) %>% cor %>% 
        hchart() %>% 
        hc_title(text = "Correlação entre as variáveis quantitativas",
                 align = "left") %>% 
        hc_subtitle(text = "Preço está mais fortemente correlacionado negativamente com a idade e positivamente com os kms por ano", 
                    align = "left") %>% 
        hc_credits(enabled = TRUE, # add credits
                   text = fonte) %>% 
        hc_exporting(enabled = TRUE) 

print_highchart(hc2, "hc2")
```


O preço correlaciona-se negativamente com os kms realizados e a idade, embora essa correlação seja mais forte com a idade (-0.72 versus -0.41), i.e., é mais importante a idade que os kms no preço de venda.

Mas temos uma descoberta que é contrária ao senso comum: o preço correlaciona-se positivamente com a média dos kms anuais, i.e., as viaturas que fazem mais kms por ano tem preços mais elevados.

Se repararmos, a média dos kms por ano correlaciona-se negativamente com a idade e essa pode ser a razão que explica esta estranha descoberta: os carros mais novos são mais utilizados e fazem em média mais kms e quando vão ficando mais velhos a sua utilização vai diminuindo. Parece ser uma explicação razoável e que faz sentido.



```{r results='asis'}
hc3 <- viaturas %>% group_by(marca) %>% 
        do(fitmodel = lm(preco ~ idade, data = .)) %>% tidy(fitmodel) %>% 
        filter(term == "idade") %>% select(estimate) %>%
        mutate(estimate = round(estimate*-1, 0)) %>%
        rename(idade = estimate) %>% 
        left_join(viaturas %>% group_by(marca) %>% 
                          do(fitmodel = lm(preco ~ kms, data = .)) %>% tidy(fitmodel) %>% 
                          filter(term == "kms") %>% select(estimate) %>%
                          mutate(estimate = round(estimate*-1000, 0)) %>% 
                          rename(kms = estimate)) %>% 
        left_join(viaturas %>% count(marca)) %>% 
        hchart(., x = kms, y = idade, type = "scatter", color = kms*idade, 
               size = n, label = marca) %>% 
        hc_title(text = "Desvalorização das marcas pela idade e kms realizados.",
                 align = "left") %>% 
        hc_subtitle(text = "Volkswagen é a marca que menos desvaloriza", 
                    align = "left") %>% 
        hc_credits(enabled = TRUE, # add credits
                   text = fonte) %>% 
        hc_yAxis(title = list(
                text = "Desvalorização no preço de venda por cada ano de idade a mais")) %>% 
        hc_xAxis(title = list(text = "Desvalorização no preço de venda por cada 1000 kms a mais")) %>% 
        hc_tooltip(useHTML = TRUE,
                   headerFormat = "<table>",
                   pointFormat = paste("<tr><th>Marca:</th><td>{point.label}</td></tr>",
                                       "<tr><th>Desvalorização por 1000 Kms:</th><td>{point.x}€</td></tr>",
                                       "<tr><th>Desvalorização por cada ano a mais:</th><td>{point.y}€</td></tr>",
                                       "<tr><th>Nº Viaturas tratadas:</th><td>{point.size}</td></tr>"),
                   footerFormat = "</table>") %>% 
        hc_exporting(enabled = TRUE) %>% 
        hc_chart(zoomType = "xy") %>%
        hc_add_theme(hc_theme_google()) 

print_highchart(hc3, "hc3")

```


<br> 
Confirmando o senso comum, a _Volkswagen_ é a marca que menos desvaloriza quer em termos da idade quer em termos dos kms realizados. 

Podemos também constatar que a desvalorização da idade e dos kms está correlacionada positivamente, conforme análise de correlação anterior, embora se verifique um _outlier_ com a _Fiat_ que desvaloriza mais com os kms do que com a idade.

Por último conseguimos claramente identificar 3 grupos de marcas, 3 com pouca desvalorização, 3 com média desvalorização e 5 com forte desvalorização.

Se o vosso interesse é escolher uma viatura que desvalorize pouco, o número de marcas com potencial interesse reduziu-se substancialmente.

<br>
<font size="2" color="grey"> <b> Quais são as melhores alternativas?</b></font>
<br>

Retomando a questão inicialmente colocada e considerando que resultou da minha pesquisa de mercado `r nrow(viaturas)` alternativas possíveis, o que devo fazer?

Certamente que não será viável ver as fotos ou consultar o equipamento e observações de todas estas viaturas, muito menos inspeciona-las fisicamente.

Mas e se conseguíssemos reduzir esse universo a apenas às 10 melhores alternativas em função de um determinado critério?

Para responder a essa questão vou considerar 4 cenários possíveis, nos quais as variáveis de decisão são o preço, a idade, os kms e a potência:

* Cenário 1: Não sei bem o que quero e, portanto, as variáveis de decisão valem todas o mesmo para mim;

* Cenário 2: valorizo mais o preço, i.e., o carro é para o meu filho e não quero gastar muito dinheiro;

* Cenário 3: valorizo mais os kms realizados, i.e., prefiro os carros com menos kms;

* Cenário 4: valorizo mais a potência, i.e, o carro é para mim e eu gosto mais dos carros mais potentes.

Mas mesmo tendo preferências, não tenho a certeza exata de quanto valorizo uma variável mais do que as outras (isto é, não consigo dizer que o preço é exatamente 3 vezes mais importante que a idade, apenas sei que para mim é um bocado mais importante) e portanto existe algum incerteza nas alternativas.

Utilizando uma das ferramentas mais úteis ao dispor do decisor, a <a href="https://pt.wikipedia.org/wiki/Simula%C3%A7%C3%A3o" target="_blank">simulação</a>, realizei 100 simulações para cada cenário em que defini um peso que espelhe as minhas preferências. No entanto, esse peso tem alguma variabilidade e no caso concreto ele varia conforme uma <a href="https://pt.wikipedia.org/wiki/Distribui%C3%A7%C3%A3o_uniforme" target="_blank">distribuição uniforme</a>. A valorização de cada viatura em cada variável de decisão foi feita com base numa <a href="https://pt.wikipedia.org/wiki/Fun%C3%A7%C3%A3o_distribui%C3%A7%C3%A3o_acumulada" target="_blank">função de distribuição acumulada</a>

<br>

Terminadas as simulações, estes são as 10 viaturas recomendadas para cada cenário:

```{r results='asis'}

runMonteCarlo <-
        function(df,
                 trials,
                 idade,
                 kms,
                 preco,
                 potencia,
                 plus) {
                # Just
                for (i in 1:trials) {
                        mc_trial_results <-
                                pesosRank(df, i, idade, kms, preco, potencia, plus)
                        
                        if (i == 1) {
                                Results <- mc_trial_results
                        } else {
                                Results <- rbind(Results, mc_trial_results)
                        }
                }
                return(Results)
        }

pesosRank <- function(df, trial, idade, kms, preco, potencia, plus) {
        peso <-
                c(
                        idade = 0,
                        kms = 0,
                        preco = 0,
                        potencia = 0
                ) # Inicializa variavel
        # order: 1 - preco; 2- idade; 3- kms
        peso["idade"] <- runif(1, idade, idade + plus)     # idade
        peso["kms"] <- runif(1, kms, kms + plus)       # kms
        peso["preco"] <- runif(1, preco, preco + plus)        # preço"
        peso["cv"] <-
                runif(1, potencia, potencia + plus)        # preço"
        
        rankSet <- df %>%
                #filter(prices <= 15000) %>%
                mutate(
                        rankIdade = cume_dist(idade),
                        rankKms = cume_dist(kms),
                        rankPreco = cume_dist(preco),
                        rankPotencia = 1 - cume_dist(potencia),
                        rankPonderado = (
                                rankIdade * peso["idade"] +
                                        rankKms * peso["kms"] +
                                        rankPreco * peso["preco"] +
                                        rankPotencia * peso["cv"]
                        ) / sum(peso),
                        trialNum = trial
                )
        #select(veiculo, rankPonderado, trialNum)
        
        
        return(rankSet)
}

mcResults <- runMonteCarlo(
        viaturas,
        trials = 100,
        idade = 50,
        kms = 50,
        preco = 50,
        potencia = 50,
        plus = 20
)
mcResults_preco <- runMonteCarlo(
        viaturas,
        trials = 100,
        idade = 10,
        kms = 10,
        preco = 80,
        potencia = 10,
        plus = 20
)
mcResults_kms <-
        runMonteCarlo(
                viaturas,
                trials = 100,
                idade = 10,
                kms = 80,
                preco = 10,
                potencia = 10,
                plus = 20
        )
mcResults_potencia <-
        runMonteCarlo(
                viaturas,
                trials = 100,
                idade = 10,
                kms = 10,
                preco = 10,
                potencia = 80,
                plus = 20
        )

simulacao <- mcResults %>%
        group_by(veiculo, marca, kms, preco, idade, potencia) %>%
        summarise(medRank = mean(rankPonderado)) %>%
        ungroup %>%
        top_n(n = 10, wt = -medRank) %>%
        arrange(medRank) %>%
        mutate(simul = "sem preferências") %>%
        bind_rows(
                mcResults_preco %>% group_by(veiculo, marca, kms, preco, idade, potencia) %>%
                        summarise(medRank = mean(rankPonderado)) %>%
                        ungroup %>%
                        top_n(n = 10, wt = -medRank) %>%
                        arrange(medRank) %>%
                        mutate(simul = "prefiro carros mais baratos")
        ) %>%
        bind_rows(
                mcResults_kms %>% group_by(veiculo, marca, kms, preco, idade, potencia) %>%
                        summarise(medRank = mean(rankPonderado)) %>%
                        ungroup %>%
                        top_n(n = 10, wt = -medRank) %>%
                        arrange(medRank) %>%
                        mutate(simul = "prefiro carros com menos kms")
        ) %>%
        bind_rows(
                mcResults_potencia %>% group_by(veiculo, marca, kms, preco, idade, potencia) %>%
                        summarise(medRank = mean(rankPonderado)) %>%
                        ungroup %>%
                        top_n(n = 10, wt = -medRank) %>%
                        arrange(medRank) %>%
                        mutate(simul = "prefiro carros com maior potência")
        )

x <- c("Veiculo: ", "Preço: ",  "Idade: ", "Kms: ", "Potência: ")
y <- sprintf("{point.%s",
             c("veiculo}", "preco:.0f} €", "idade:.0f} anos", "kms:.0f} kms", "potencia:.0f} cv"))

tltip <- tooltip_table(x, y)

hc4_1 <- simulacao %>% filter(simul == "sem preferências") %>%
                hchart(
                        .,
                        x = veiculo,
                        y = medRank,
                        type = "bar",
                        color = factor(marca)
                ) %>%
                hc_title(text = paste0("Cenário: sem preferências"),
                         align = "left") %>%
                hc_subtitle(text = "Coloque o cursor sobre as barras para visualizar as variáveis",
                            align = "left") %>%
                hc_yAxis(
                        title = list(text = "Ranking. Valor mais baixo é melhor"),
                        align = "left",
                        showFirstLabel = FALSE,
                        showLastLabel = FALSE,
                        max = 0.3
                ) %>%
                hc_xAxis(title = list(text = ""), fontsize = 8) %>%
                hc_plotOptions(bar = list(dataLabels = list(
                        enabled = TRUE,
                        format = '{point.y:.3f}'
                ))) %>%
                hc_tooltip(
                        useHTML = TRUE,
                        headerFormat = "",
                        pointFormat = tltip
                ) %>%
                #hc_exporting(enabled = TRUE) %>%
                hc_add_theme(hc_theme_flat())

hc4_2 <- simulacao %>% filter(simul == "prefiro carros mais baratos") %>%
                hchart(
                        .,
                        x = veiculo,
                        y = medRank,
                        type = "bar",
                        color = factor(marca)
                ) %>%
                hc_title(text = paste0("Cenário: prefiro carros mais baratos"),
                         align = "left") %>%
                hc_subtitle(text = "Coloque o cursor sobre as barras para visualizar as variáveis",
                            align = "left") %>%
                hc_yAxis(
                        title = list(text = "Ranking. Valor mais baixo é melhor"),
                        align = "left",
                        showFirstLabel = FALSE,
                        showLastLabel = FALSE,
                        max = 0.3
                ) %>%
                hc_xAxis(title = list(text = ""), fontsize = 8) %>%
                hc_plotOptions(bar = list(dataLabels = list(
                        enabled = TRUE,
                        format = '{point.y:.3f}'
                ))) %>%
                hc_tooltip(
                        useHTML = TRUE,
                        headerFormat = "",
                        pointFormat = tltip
                ) %>%
                #hc_exporting(enabled = TRUE) %>%
                hc_add_theme(hc_theme_flat())

hc4_3 <- simulacao %>% filter(simul == "prefiro carros com menos kms") %>%
                hchart(
                        .,
                        x = veiculo,
                        y = medRank,
                        type = "bar",
                        color = factor(marca)
                ) %>%
                hc_title(text = paste0("Cenário: prefiro carros com menos kms"),
                         align = "left") %>%
                hc_subtitle(text = "Coloque o cursor sobre as barras para visualizar as variáveis",
                            align = "left") %>%
                hc_yAxis(
                        title = list(text = "Ranking. Valor mais baixo é melhor"),
                        align = "left",
                        showFirstLabel = FALSE,
                        showLastLabel = FALSE,
                        max = 0.3
                ) %>%
                hc_xAxis(title = list(text = ""), fontsize = 8) %>%
                hc_plotOptions(bar = list(dataLabels = list(
                        enabled = TRUE,
                        format = '{point.y:.3f}'
                ))) %>%
                hc_tooltip(
                        useHTML = TRUE,
                        headerFormat = "",
                        pointFormat = tltip
                ) %>%
                #hc_exporting(enabled = TRUE) %>%
                hc_add_theme(hc_theme_flat())

hc4_4 <- simulacao %>% filter(simul == "prefiro carros com maior potência") %>%
                hchart(
                        .,
                        x = veiculo,
                        y = medRank,
                        type = "bar",
                        color = factor(marca)
                ) %>%
                hc_title(text = paste0("Cenário: prefiro carros com maior potência"),
                         align = "left") %>%
                hc_subtitle(text = "Coloque o cursor sobre as barras para visualizar as variáveis",
                            align = "left") %>%
                hc_yAxis(
                        title = list(text = "Ranking. Valor mais baixo é melhor"),
                        align = "left",
                        showFirstLabel = FALSE,
                        showLastLabel = FALSE,
                        max = 0.3
                ) %>%
                hc_xAxis(title = list(text = ""), fontsize = 8) %>%
                hc_plotOptions(bar = list(dataLabels = list(
                        enabled = TRUE,
                        format = '{point.y:.3f}'
                ))) %>%
                hc_tooltip(
                        useHTML = TRUE,
                        headerFormat = "",
                        pointFormat = tltip
                ) %>%
                #hc_exporting(enabled = TRUE) %>%
                hc_add_theme(hc_theme_flat())
print_highchart(hc4_1, "hc4_1", 800, 450)
print_highchart(hc4_2, "hc4_2", 800, 450)
print_highchart(hc4_3, "hc4_3", 800, 450)
print_highchart(hc4_4, "hc4_4", 800, 450)

```

Podem reparar, analisando as diferentes variáveis, que as viaturas selecionadas favorecem as prioridades definidas em cada cenário mas sempre considerando as restantes variáveis. Por exemplo, no cenário de melhor preço as viaturas escolhidas não são as mais baratas: são as que apresentam os melhores preços considerando igualmente os kms feitos, a potência e a idade.

Reduzimos as nossas alternativas de `r nrow(viaturas)` viaturas para apenas 10 em cada cenário, selecionadas em função das nossas prioridades. Podemos agora analisar com detalhe as 10 viaturas propostas e eventualmente inspeciona-las fisicamente antes da decisão final.

<br>
<font size="2" color="grey"> <b> Qual o preço a que devo colocar à venda o meu carro? </b></font>
<br>

```{r}
modelos <- viaturas %>%
        mutate(marca_modelo = str_c(marca, modelo, sep = " ")) %>% 
        count(marca_modelo) %>% 
        #top_n(n = 3, wt = n) %>%
        filter(n>100) %>% 
        .$marca_modelo %>% as.character

viaturas_lm <- viaturas %>% mutate(marca_modelo = str_c(marca, modelo, sep = " ")) %>%
        filter(marca_modelo %in% modelos) 
lm5 <- lm(preco ~ kms + idade + potencia + cilindrada + marca_modelo, data = viaturas_lm)

new_cars <- tibble(
        marca_modelo = c("volkswagen golf",
                         "peugeot 208",
                         "renault megane",
                         "opel astra"),
        kms = runif(4, 35000, 180000),
        idade = c(5, 7, 9, 12),
        potencia = c(110, 92, 90, 125),
        cilindrada = c(1.9, 1.6, 1.5, 1.7),
        veiculo = str_c(marca_modelo, " ", cilindrada, "cc ", 
                        potencia, "cv ", round(kms,0), "kms ",
                        idade, " anos", sep = "")
)

```

Mas e se eu quiser ter uma ideia do preço que custaria uma viatura que reúne um conjunto de características que não estão presentes nas viaturas à venda nos dois sites que pesquisei?

Ou, melhor ainda, se eu tiver um carro que quero vender, qual o preço que devo pedir?

Foi construido um modelo para prever o valor de venda esperado, modelo que considerou as variáveis kms, idade, potência, cilindrada, marca e modelo. O modelo consegue explicar __`r percent(summary(lm5)$r.squared, 2)`__ da variação do valor, o que é bastante positivo.

Com base no modelo podemos prever o valor de venda para viaturas com as caracteristicas que estejam dentro dos intervalos utilizados na construção do modelo. Para teste simulei 4 viaturas com as seguintes caracteristicas: `r new_cars %>% select(veiculo) %>% .$veiculo %>% paste0(., collapse = ", ")`.


O valor de venda previsto, se pretendermos praticar preços de acordo com os que estavam a ser praticados à data da recolha dos dados nos dois sites de onde extraimos a informação, assim como o intervalo de confiança de 90% para esse valor médio (probabilidade de um carro com aquelas caracteristicas ser vendido dentro do nosso intervalo), constam do seguinte gráfico:

```{r}
predict(lm5,  new_cars, level = 0.9, se.fit = TRUE, interval = "prediction")$fit %>% 
        as_data_frame %>% 
        bind_cols(new_cars %>% select(veiculo)) %>% 
        ggplot(aes(y = fit, x = veiculo, color = veiculo)) + geom_point(size = 3) +
        geom_text_repel(aes(label = currency(fit, digits =0, symbol = "€"))) + 
        geom_linerange(aes(ymin = lwr, ymax = upr), size = 1.5) + 
        labs(title = "Previsão de valores de venda", 
             subtitle = "Intervalo de confiança de 90%. ",
             x = "",
             y = "Valores previstos em Euros") +
        coord_flip() +
        guides(color = FALSE) +
        scale_color_futurama() +
        theme_fivethirtyeight() 
        
```

Podemos a partir daqui decidir qual o preço que podemos praticar, definindo o preço final em função de termos ou não urgência na venda, o carro ter mais ou menos equipamento que o normal, o estado da viatura ser bom ou mau, etc. Mas temos um bom ponto de partida com o intervalo calculado.

<br>
<font size="2" color="grey"> <b> Questões finais </b></font>
<br>


Tentei não me alongar muito para não vos cansar.

Na presença de outros dados, por exemplo, se a viatura foi ou não vendida, quanto tempo esteve à venda sem ser vendida, qual o preço final de venda (dados que certamente um stand ou marca disporá), poderia responder a questões interessantes, como por exemplo:

* Se colocar o meu carro à venda por x Euros, quanto tempo tenho de esperar para fechar negócio?

* Qual o preço que devo pedir se quiser fechar negócio nos próximos 15 dias?


Com este exemplo simples, espero ter conseguido demonstrar, com utilização de algumas técnicas, a importância da informação para extrair conhecimento e potenciar a boa decisão.




